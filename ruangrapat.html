<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ruang Rapat</title>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        html, body {
            height: 100%; margin: 0; font-family: 'Inter', sans-serif;
            background: #f0f2f5; color: #333;
        }
        body {
            display: flex; flex-direction: column; height: 100vh; overflow: hidden; padding-top: 52px;
        }
        
        /* Header dan Menu */
        header {
            position: fixed; top: 0; left: 0; width: 100%; height: 52px;
            background: #00BCD4; color: white; display: flex;
            align-items: center; padding: 0 16px; border-bottom: 1px solid #0097A7; z-index: 1001;
        }
        header h1 { font-size: 18px; margin: 0; margin-left: 16px; flex-grow: 1; }
        header .back-btn { color: white; text-decoration: none; display: flex; align-items: center; font-size: 24px; transition: transform 0.2s; }
        header .back-btn:active { transform: scale(0.9); }
        
        .menu-button { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0 8px; }
        .dropdown-menu {
            position: absolute; top: 52px; right: 16px; background: white;
            border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            min-width: 150px; z-index: 1002; display: none; list-style-type: none; padding: 8px 0; margin: 0;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-menu li a { display: block; padding: 10px 16px; text-decoration: none; color: #333; font-size: 14px; transition: background-color 0.2s; }
        .dropdown-menu li a:hover { background-color: #f0f2f5; }

        #chat { flex: 1; overflow-y: auto; padding: 1rem 1.5rem; background: #fff; border-bottom: 1px solid #ddd; }
        .msg { margin-bottom: 1rem; padding: 0.75rem 1rem; background: #eef1f5; border-radius: 8px; animation: fadeIn 0.3s ease-in-out; max-width: 100%; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; }
        .msg strong { color: #2c3e50; }
        .msg span { display: block; margin-top: 4px; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Area Izin Bicara dan Kirim */
        #speakBox { 
            padding: 1rem 1.5rem;
            background: #ffffff;
            border-top: 2px solid #00BCD4;
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
        }
        #kirim {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
            border: none;
            border-radius: 50%;
            background: #00BCD4;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #kirim:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #kirim:hover:enabled {
            background: #0097A7;
        }
        #kirim .material-icons { font-size: 24px; }

        /* Area Input Chat */
        #inputChat {
            flex: 1;
            padding: 0.6rem 1rem;
            border: 1px solid #ccc;
            border-radius: 20px;
            font-size: 1rem;
            resize: none;
            min-height: 40px;
            max-height: 200px;
            overflow-y: auto;
            line-height: 1.4;
            font-family: 'Inter', sans-serif;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        #inputChat:focus {
            outline: none;
            border-color: #00BCD4;
            box-shadow: 0 0 0 2px #00BCD4;
        }
        
        #votingBox { display: none; padding: 1rem 1.5rem; background: #ffffff; border-top: 2px solid #00BCD4; }
        #votingBox h3 { margin-top: 0; color: #00796B; }
        .option-button { background: #00BCD4; color: white; padding: 0.5rem 1rem; margin: 0.25rem; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
        .option-button:hover { background: #0097A7; }

        /* Sidebar Catatan */
        #catatanSidebar {
          position: fixed; top: 52px; right: -320px;
          width: 300px; height: calc(100vh - 52px);
          background-color: #fff; box-shadow: -2px 0 10px rgba(0,0,0,0.1);
          transition: right 0.3s ease-in-out;
          display: flex; flex-direction: column;
          z-index: 1000;
        }
        #catatanSidebar.show { right: 0; }
        #catatanSidebar .sidebar-header {
          display: flex; justify-content: space-between; align-items: center;
          padding: 1rem; border-bottom: 1px solid #eee;
        }
        #catatanSidebar .sidebar-header h3 { margin: 0; color: #00796B; }
        #catatanSidebar .sidebar-header .close-btn {
          background: none; border: none; font-size: 24px;
          cursor: pointer; color: #999;
        }
        #catatanTextarea {
          flex: 1; padding: 1rem; border: none;
          resize: none; font-family: 'Inter', sans-serif;
          font-size: 14px; line-height: 1.5;
        }
        #catatanTextarea:focus { outline: none; }
    </style>
</head>
<body>

<header>
    <a href="#" id="backBtn" class="back-btn"><i class="material-icons">arrow_back</i></a>
    <h1 id="rapatJudul">Ruang Rapat</h1>
    <button class="menu-button" id="menuBtn"><i class="material-icons">more_vert</i></button>
    <ul class="dropdown-menu" id="dropdownMenu">
        <li><a href="#" id="menuPemimpin">Pemimpin</a></li>
        <li><a href="#" id="mintaIzinBtn">üéôÔ∏è Minta Izin Bicara</a></li>
        <li><a href="#" id="bukaCatatanBtn">üìù Catatan</a></li>
    </ul>
</header>

<div id="chat"></div>
<div id="votingBox"></div>

<div id="speakBox">
    <textarea id="inputChat" placeholder="Ketik pesan..." disabled></textarea>
    <button id="kirim" disabled><i class="material-icons">send</i></button>
</div>

<div id="catatanSidebar">
  <div class="sidebar-header">
    <h3>Catatan Pribadi</h3>
    <button id="tutupCatatanBtn" class="close-btn">&times;</button>
  </div>
  <textarea id="catatanTextarea" placeholder="Tulis catatan di sini..."></textarea>
</div>

<audio id="audio" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onChildAdded, onValue, set, get, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    const firebaseConfig = {
        apiKey: "AIzaSyDguC7UH1JUzBQu1JZX8qPJGVeb6Pc7t98",
        authDomain: "pustakawan-26664.firebaseapp.com",
        databaseURL: "https://pustakawan-26664-default-rtdb.firebaseio.com",
        projectId: "pustakawan-26664",
        storageBucket: "pustakawan-26664.appspot.com",
        messagingSenderId: "284579513964",
        appId: "1:284579513964:web:b45f73ac287e1f49eeba49"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    const rapatId = urlParams.get('rapat');

    const backBtn = document.getElementById('backBtn');
    const chatBox = document.getElementById('chat');
    const inputChat = document.getElementById('inputChat');
    const kirimBtn = document.getElementById('kirim');
    const rapatJudulEl = document.getElementById('rapatJudul');
    const votingBox = document.getElementById('votingBox');
    const audio = document.getElementById('audio');
    const menuBtn = document.getElementById('menuBtn');
    const dropdownMenu = document.getElementById('dropdownMenu');
    const menuPemimpin = document.getElementById('menuPemimpin');

    // Elemen baru untuk "Minta Izin Bicara" di dropdown
    const mintaIzinBtn = document.getElementById('mintaIzinBtn');
    const bukaCatatanBtn = document.getElementById('bukaCatatanBtn');
    const catatanSidebar = document.getElementById('catatanSidebar');
    const tutupCatatanBtn = document.getElementById('tutupCatatanBtn');
    const catatanTextarea = document.getElementById('catatanTextarea');
    
    let namaPengguna = id;
    let isSpeaking = false;
    let debounceTimeout;

    function debounce(func, delay) {
      return function(...args) {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    async function init() {
        if (!id || !rapatId) {
            document.body.innerHTML = "<h1>Akses ditolak. Mohon login dan pilih rapat.</h1>";
            return;
        }

        backBtn.href = `rapat.html?id=${id}`;

        const [namaSnap, rapatSnap] = await Promise.all([
          get(ref(db, `pustakawan/${id}/nama`)),
          get(ref(db, `rapat/${rapatId}/judul`))
        ]);
        if (namaSnap.exists()) namaPengguna = namaSnap.val();
        if (rapatSnap.exists()) rapatJudulEl.textContent = rapatSnap.val();

        onChildAdded(ref(db, `rapat/${rapatId}/chat`), snap => {
            const { nama, isi } = snap.val();
            tampilkanChat(nama, isi);
        });

        onValue(ref(db, `rapat/${rapatId}/voting`), snap => {
            const votingData = snap.val();
            votingBox.innerHTML = '';
            if (votingData) {
                votingBox.style.display = 'block';
                votingBox.innerHTML = `<h3>Voting: ${votingData.judul}</h3>`;
                votingData.opsi.forEach(o => {
                    const btn = document.createElement('button');
                    btn.className = 'option-button';
                    btn.textContent = o;
                    btn.onclick = () => kirimVoting(o);
                    votingBox.appendChild(btn);
                });
            } else {
                votingBox.style.display = 'none';
            }
        });
        
        onValue(ref(db, `rapat/${rapatId}/respon/${id}`), snap => {
            const respon = snap.val();
            if (respon) {
                if (respon === 'izinkan') {
                    isSpeaking = true;
                    inputChat.disabled = false;
                    kirimBtn.disabled = false;
                    mintaIzinBtn.textContent = '‚úÖ Diizinkan!';
                    audio.play(); navigator.vibrate?.(300);
                } else if (respon === 'tolak') {
                    mintaIzinBtn.textContent = 'üéôÔ∏è Minta Izin Bicara';
                    mintaIzinBtn.style.pointerEvents = 'auto';
                    audio.play(); navigator.vibrate?.(300);
                }
                setTimeout(() => {
                    remove(ref(db, `rapat/${rapatId}/respon/${id}`));
                }, 3000);
            }
        });

        onValue(ref(db, `rapat/${rapatId}/catatan/${id}`), snap => {
            if (snap.exists()) {
                catatanTextarea.value = snap.val();
            }
        });

        catatanTextarea.addEventListener('input', debounce(() => {
            set(ref(db, `rapat/${rapatId}/catatan/${id}`), catatanTextarea.value);
        }, 500));

        mintaIzinBtn.onclick = (e) => {
            e.preventDefault();
            dropdownMenu.classList.remove('show');
            set(ref(db, `rapat/${rapatId}/permintaan/${id}`), { nama: namaPengguna, waktu: Date.now() });
            mintaIzinBtn.style.pointerEvents = 'none';
            mintaIzinBtn.textContent = 'Menunggu Izin...';
        };

        kirimBtn.onclick = () => {
            const teks = inputChat.value.trim();
            if (!teks || !isSpeaking) return;

            set(ref(db, `rapat/${rapatId}/chat/${Date.now()}`), {
                nama: namaPengguna,
                isi: teks
            });
            inputChat.value = '';
            inputChat.style.height = '40px';

            isSpeaking = false;
            inputChat.disabled = true;
            kirimBtn.disabled = true;
            mintaIzinBtn.style.pointerEvents = 'auto';
            mintaIzinBtn.textContent = 'üéôÔ∏è Minta Izin Bicara';
        };
        
        menuBtn.onclick = (e) => {
            e.stopPropagation();
            dropdownMenu.classList.toggle('show');
        };
        
        bukaCatatanBtn.onclick = () => {
            dropdownMenu.classList.remove('show');
            catatanSidebar.classList.add('show');
        };

        tutupCatatanBtn.onclick = () => {
            catatanSidebar.classList.remove('show');
        };
        
        menuPemimpin.onclick = () => {
             window.location.href = `pw.html?id=${id}&rapat=${rapatId}`;
        };
        
        document.addEventListener('click', (event) => {
            if (!menuBtn.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.classList.remove('show');
            }
        });

        inputChat.addEventListener('input', () => {
            inputChat.style.height = 'auto';
            inputChat.style.height = inputChat.scrollHeight + 'px';
        });

        inputChat.disabled = true;
        kirimBtn.disabled = true;
    }

    async function kirimVoting(opsi) {
        set(ref(db, `rapat/${rapatId}/jawabanVoting/${id}`), opsi);
        votingBox.innerHTML = `<h3>Terima kasih, suara Anda sudah terkirim.</h3>`;
    }

    function tampilkanChat(nama, isi) {
        const el = document.createElement('div');
        el.className = 'msg';
        const isiEl = document.createElement('span');
        isiEl.innerHTML = isi;
        if (nama) {
            const namaEl = document.createElement('strong');
            namaEl.textContent = nama;
            el.appendChild(namaEl);
        }
        el.appendChild(isiEl);
        chatBox.appendChild(el);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    init();
</script>
</body>
</html>
