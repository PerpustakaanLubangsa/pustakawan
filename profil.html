<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Profil Pustakawan</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Gaya Dasar */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            background: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding-top: 52px;
            padding-bottom: 72px; 
        }

        /* Header yang Tetap di Atas */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            width: 100%;
            height: auto;
            background: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 24px;
            border-bottom: 1px solid #ddd;
        }
        
        header .title-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
        }

        header h1 {
            font-size: 18px;
            margin: 0;
            color: #00ACC1;
        }
        
        header small {
            font-size: 12px;
            color: #777;
            margin-top: 2px;
        }
        
        header button {
            width: 48px;
            height: 48px;
            font-size: 24px;
            border: none;
            border-radius: 50%;
            background: #00ACC1;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: transform 0.2s;
        }
        
        header button:active {
            transform: scale(0.9);
        }

        /* Konten Utama */
        main {
            flex: 1;
            padding: 16px 24px;
            width: 100%;
        }

        .profil-container {
            background: #ffffff;
            border-radius: 8px;
            padding: 24px;
            max-width: 600px;
            margin: auto;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .profil-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .profil-header h2 {
            font-size: 22px;
            margin: 0;
            color: #00ACC1;
        }

        .profil-header .jabatan {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
            display: block;
        }

        .info {
            margin-bottom: 20px;
        }

        .info label {
            display: block;
            font-size: 14px;
            color: #777;
            margin-bottom: 8px;
        }

        .info input {
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
            background: #f8f8f8;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 24px;
            transition: border-color 0.2s;
            outline: none;
        }

        .info input:read-only {
            background: #ffffff;
            border-color: transparent;
        }

        .info input:focus:not([readonly]) {
            border-color: #00ACC1;
        }
        
        .divider {
            border: none;
            height: 1px;
            background-color: #eee;
            margin: 32px 0;
        }

        .dynamic-fields {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .dynamic-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: transparent;
            border: none;
            padding: 0;
            position: relative;
        }
        
        .dynamic-field .field-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .dynamic-field input {
            width: 100%;
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background: #ffffff;
            font-size: 14px;
        }

        .dynamic-field .view-only {
            padding: 0;
        }
        
        .dynamic-field .delete-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            font-size: 14px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* GAYA DROPDOWN URUTAN */
        .dynamic-field .field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dynamic-field select.field-order {
            padding: 4px 8px;
            border-radius: 12px;
            border: 1px solid #ddd;
            background: #fff;
            font-size: 12px;
            color: #555;
            cursor: pointer;
        }

        /* GAYA TOMBOL TAMBAH KETERANGAN BARU */
        .add-btn-minimalist {
            width: 100%;
            padding: 12px;
            margin-top: 24px;
            background: #fff;
            color: #00ACC1;
            border: 1px dashed #00ACC1;
            border-radius: 24px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.2s;
            display: none; /* Sembunyikan secara default */
        }
        
        .add-btn-minimalist:hover {
            background: #e0f7fa;
        }

        #notif {
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
            color: #f44336;
        }
        
        /* Navigasi Bawah yang Tetap */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 60px;
            background: #ffffff;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }
        
        .bottom-nav .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            height: 100%;
            text-decoration: none;
            color: #888;
            transition: color 0.2s;
        }

        .bottom-nav .nav-item.active {
            color: #00ACC1;
        }

        .bottom-nav .nav-item:hover {
            color: #00ACC1;
        }

        .bottom-nav .nav-item .material-icons {
            font-size: 24px;
            margin-bottom: 2px;
        }
        
        .bottom-nav .nav-item span {
            font-size: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <header>
        <div class="title-container">
            <h1 id="fnamaHeader">Profil</h1>
            <small id="fjabatanHeader"></small>
        </div>
        <button id="tombolAksi"><i class="material-icons">edit</i></button>
    </header>

    <main>
        <div class="profil-container">
            <div class="profil-header">
                <h2 id="fnamaDisplay">Nama Pengguna</h2>
                <span id="fjabatanDisplay" class="jabatan">Jabatan</span>
            </div>
            
            <div class="info-group">
                <div class="info"><label>ID</label><input id="fid" readonly /></div>
                <div class="info"><label>Anggota Sejak</label><input id="fsejak" readonly /></div>
            </div>
            
            <hr class="divider">
            
            <div id="dynamic-fields">
                </div>
            
            <button id="add-field-btn" class="add-btn-minimalist"><i class="material-icons">add</i> Tambah Keterangan</button>
            
            <div id="notif"></div>
        </div>
    </main>

    <nav class="bottom-nav">
        <a href="beranda.html?id=" id="linkBeranda" class="nav-item">
            <i class="material-icons">home</i>
            <span>Beranda</span>
        </a>
        <a href="catatan.html?id=" id="linkCatatan" class="nav-item">
            <i class="material-icons">note</i>
            <span>Catatan</span>
        </a>
        <a href="rapat.html?id=" id="linkRapat" class="nav-item">
            <i class="material-icons">event</i>
            <span>Rapat</span>
        </a>
        <a href="profil.html?id=" id="linkProfil" class="nav-item active">
            <i class="material-icons">person</i>
            <span>Profil</span>
        </a>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, get, update, push, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDguC7UH1JUzBQu1JZX8qPJGVeb6Pc7t98",
            authDomain: "pustakawan-26664.firebaseapp.com",
            projectId: "pustakawan-26664",
            storageBucket: "pustakawan-26664.appspot.com",
            messagingSenderId: "284579513964",
            appId: "1:284579513964:web:b45f73ac287e1f49eeba49",
            databaseURL: "https://pustakawan-26664-default-rtdb.firebaseio.com"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(location.search);
        const userId = urlParams.get("id");

        if (!userId) {
            document.body.innerHTML = "<main style='padding:64px 24px;font-size:18px;'>Akses ditolak. Mohon login.</main>";
            throw new Error("Akses ditolak");
        }

        const refs = {
            fid: document.getElementById("fid"),
            fsejak: document.getElementById("fsejak"),
            fnamaHeader: document.getElementById("fnamaHeader"),
            fjabatanHeader: document.getElementById("fjabatanHeader"),
            fnamaDisplay: document.getElementById("fnamaDisplay"),
            fjabatanDisplay: document.getElementById("fjabatanDisplay"),
        };
        
        const dynamicFieldsContainer = document.getElementById("dynamic-fields");
        const notif = document.getElementById("notif");
        const tombolAksi = document.getElementById("tombolAksi");
        const addFieldBtn = document.getElementById("add-field-btn");

        function tampilNotif(teks, warna = "#f44336") {
            notif.textContent = teks;
            notif.style.color = warna;
        }

        async function muatProfil() {
            const linkIDs = ["linkBeranda", "linkCatatan", "linkRapat", "linkProfil"];
            linkIDs.forEach(linkId => {
                const el = document.getElementById(linkId);
                if (el) {
                    const url = new URL(el.getAttribute("href"), location.href);
                    url.searchParams.set("id", userId);
                    el.setAttribute("href", url.toString());
                }
            });

            const refData = ref(db, `pustakawan/${userId}`);
            const snap = await get(refData);
            if (snap.exists()) {
                const data = snap.val();
                
                refs.fid.value = userId;
                refs.fsejak.value = data.sejak || "";
                
                refs.fnamaHeader.textContent = data.nama || "(Tanpa Nama)";
                refs.fjabatanHeader.textContent = data.jabatan || "";
                refs.fnamaDisplay.textContent = data.nama || "(Tanpa Nama)";
                refs.fjabatanDisplay.textContent = data.jabatan || "";
                
            } else {
                tampilNotif("Profil tidak ditemukan", "red");
            }
        }
        
        let isEditing = false;
        
        function renderDynamicFields(data) {
            // Urutkan data berdasarkan properti 'order'
            const sortedData = Object.keys(data || {}).map(key => ({
                id: key,
                ...data[key]
            })).sort((a, b) => (a.order || 9999) - (b.order || 9999));

            dynamicFieldsContainer.innerHTML = "";
            const totalFields = sortedData.length;

            sortedData.forEach(field => {
                const div = document.createElement("div");
                div.className = "dynamic-field info";
                div.setAttribute("data-key", field.id);

                if (isEditing) {
                    // Buat dropdown untuk urutan
                    let orderOptions = '';
                    for (let i = 1; i <= totalFields; i++) {
                        orderOptions += `<option value="${i}" ${field.order == i ? 'selected' : ''}>Posisi ${i}</option>`;
                    }

                    div.innerHTML = `
                        <div class="field-header">
                            <label>Urutan:</label>
                            <select class="field-order">${orderOptions}</select>
                        </div>
                        <label>
                            <input type="text" class="field-title" value="${field.title || ''}" placeholder="Judul Keterangan" />
                        </label>
                        <input type="text" class="field-value" value="${field.value || ''}" placeholder="Isi Keterangan" />
                        <button class="delete-btn"><i class="material-icons">close</i></button>
                    `;
                    div.querySelector('.delete-btn').addEventListener('click', () => hapusKeterangan(field.id));
                } else {
                    div.innerHTML = `
                        <label>${field.title || ''}</label>
                        <input type="text" value="${field.value || ''}" readonly />
                    `;
                }

                dynamicFieldsContainer.appendChild(div);
            });
        }

        function toggleEditMode() {
            isEditing = !isEditing;
            tombolAksi.innerHTML = isEditing ? '<i class="material-icons">done</i>' : '<i class="material-icons">edit</i>';
            addFieldBtn.style.display = isEditing ? 'flex' : 'none';
            
            tampilNotif(isEditing ? "Mode edit diaktifkan. Anda bisa menambah/menghapus keterangan." : "", isEditing ? "#4caf50" : "");
            
            onValue(ref(db, `pustakawan/${userId}/keteranganTambahan`), (snapshot) => {
                const data = snapshot.val() || {};
                renderDynamicFields(data);
            }, { onlyOnce: true });
        }
        
        async function tambahKeterangan() {
            const snapshot = await get(ref(db, `pustakawan/${userId}/keteranganTambahan`));
            const existingData = snapshot.val() || {};
            const nextOrder = Object.keys(existingData).length + 1;

            const newFieldRef = push(ref(db, `pustakawan/${userId}/keteranganTambahan`));
            await update(newFieldRef, {
                title: '',
                value: '',
                order: nextOrder
            });
        }

        async function simpanPerubahan() {
            const fieldsToUpdate = {};
            const dynamicFields = document.querySelectorAll('.dynamic-field');
            const newOrderMap = new Map();
            let newOrderCounter = 1;

            // Prioritaskan urutan dari dropdown, jika ada duplikasi, urutkan ulang
            const orderedInputs = [...dynamicFields].sort((a, b) => {
                const orderA = parseInt(a.querySelector('.field-order').value);
                const orderB = parseInt(b.querySelector('.field-order').value);
                return orderA - orderB;
            });
            
            orderedInputs.forEach(field => {
                const key = field.getAttribute('data-key');
                const title = field.querySelector('.field-title').value.trim();
                const value = field.querySelector('.field-value').value.trim();
                
                if (title || value) {
                    fieldsToUpdate[key] = {
                        title,
                        value,
                        order: newOrderCounter++
                    };
                } else {
                    // Hapus data jika judul & isi kosong
                    remove(ref(db, `pustakawan/${userId}/keteranganTambahan/${key}`));
                }
            });
            
            try {
                // Update semua data keterangan tambahan
                await update(ref(db, `pustakawan/${userId}/keteranganTambahan`), fieldsToUpdate);
                tampilNotif("✅ Profil berhasil disimpan.", "#4caf50");
                toggleEditMode();
            } catch (err) {
                console.error(err);
                tampilNotif("❌ Gagal menyimpan profil.", "red");
            }
        }

        async function hapusKeterangan(key) {
            if (confirm("Yakin ingin menghapus keterangan ini?")) {
                await remove(ref(db, `pustakawan/${userId}/keteranganTambahan/${key}`));
            }
        }
        
        tombolAksi.addEventListener('click', () => {
            if (isEditing) {
                simpanPerubahan();
            } else {
                toggleEditMode();
            }
        });
        
        addFieldBtn.addEventListener('click', tambahKeterangan);
        
        onValue(ref(db, `pustakawan/${userId}/keteranganTambahan`), (snapshot) => {
            const data = snapshot.val() || {};
            renderDynamicFields(data);
        });

        muatProfil();
    </script>
</body>
</html>
