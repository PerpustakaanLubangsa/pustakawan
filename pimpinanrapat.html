<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pimpinan Rapat</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #f0f2f5;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #votingCountdown {
      background: #ffe;
      text-align: center;
      font-weight: bold;
      padding: 0.5rem;
      display: none;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 1.5rem;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }

    .msg {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      background: #eef1f5;
      border-radius: 8px;
      animation: fadeIn 0.3s ease-in-out;
      max-width: 100%;
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
    }

    .msg strong {
      color: #2c3e50;
    }

    .msg span {
      display: block;
      margin-top: 4px;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    #permintaanBox {
      background: #fffbe6;
      padding: 1rem;
      border-top: 1px solid #ddd;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
      display: none;
      font-weight: 500;
    }

    #permList {
      display: none;
      padding: 1rem;
      background: #fffde7;
      border-bottom: 1px solid #ddd;
    }

    #permList div {
      margin-bottom: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #permList button {
      margin-left: 0.5rem;
      padding: 0.4rem 0.75rem;
      border: none;
      background: #4a90e2;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }

    #controls {
      padding: 1rem 1.5rem;
      background: #f5f5f5;
      display: flex;
      gap: 0.5rem;
      border-top: 1px solid #ccc;
    }

    #inputChat {
      flex: 1;
      padding: 0.6rem 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    button {
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 6px;
      background: #4a90e2;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }

    button:hover {
      background: #3b7dc4;
    }

    #votingForm {
      display: none;
      padding: 1rem 1.5rem;
      background: #eaf3ff;
      border-top: 2px solid #4a90e2;
    }

    #votingForm h3 {
      margin-top: 0;
    }

    #votingForm input, #votingForm textarea {
      width: 100%;
      padding: 0.6rem;
      margin-bottom: 1rem;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-family: 'Inter', sans-serif;
    }

    @media (max-width: 600px) {
      #controls {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

<div id="votingCountdown"></div>
<div id="chat"></div>
<div id="permintaanBox">üîî Ada <span id="jmlPermintaan">0</span> permintaan bicara (klik untuk lihat)</div>
<div id="permList"></div>

<div id="controls">
  <input type="text" id="inputChat" placeholder="Ketik pesan...">
  <button id="kirim">Kirim</button>
  <button id="bukaVoting">üó≥Ô∏è Buat Voting</button>
</div>

<div id="votingForm">
  <h3>Buat Voting</h3>
  <input type="text" id="judulVoting" placeholder="Judul voting">
  <textarea id="opsiVoting" placeholder="Tulis opsi, satu per baris..." rows="4"></textarea>
  <button id="kirimVoting">Mulai Voting (10 detik)</button>
</div>

<audio id="audio" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDguC7UH1JUzBQu1JZX8qPJGVeb6Pc7t98",
  authDomain: "pustakawan-26664.firebaseapp.com",
  databaseURL: "https://pustakawan-26664-default-rtdb.firebaseio.com",
  projectId: "pustakawan-26664",
  storageBucket: "pustakawan-26664.appspot.com",
  messagingSenderId: "284579513964",
  appId: "1:284579513964:web:b45f73ac287e1f49eeba49"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const urlParams = new URLSearchParams(window.location.search);
const id = urlParams.get('id');
const rapatId = urlParams.get('rapat');

const chatBox = document.getElementById('chat');
const inputChat = document.getElementById('inputChat');
const kirimBtn = document.getElementById('kirim');
const bukaVotingBtn = document.getElementById('bukaVoting');
const votingForm = document.getElementById('votingForm');
const kirimVoting = document.getElementById('kirimVoting');
const permintaanBox = document.getElementById('permintaanBox');
const permList = document.getElementById('permList');
const jmlPermintaan = document.getElementById('jmlPermintaan');
const votingCountdown = document.getElementById('votingCountdown');
const audio = document.getElementById('audio');

let namaPengguna = id;
db.ref(`pustakawan/${id}/nama`).once('value', s => {
  if (s.exists()) namaPengguna = s.val();
});

function tampilkanChat(nama, isi) {
  const el = document.createElement('div');
  el.className = 'msg';
  const namaEl = document.createElement('strong'); namaEl.textContent = nama;
  const isiEl = document.createElement('span');
  el.append(namaEl, isiEl);
  chatBox.appendChild(el);
  chatBox.scrollTop = chatBox.scrollHeight;

  if (['üìä', 'üó≥Ô∏è', '‚úÖ', '‚ùå'].includes(nama)) {
    isiEl.innerHTML = isi;
  } else {
    isiEl.textContent = isi;
  }
}

db.ref(`rapat/${rapatId}/chat`).on('child_added', snap => {
  tampilkanChat(snap.val().nama, snap.val().isi);
});

kirimBtn.onclick = () => {
  const teks = inputChat.value.trim();
  if (!teks) return;
  db.ref(`rapat/${rapatId}/chat/${Date.now()}`).set({
    nama: `${namaPengguna} Pemimpin Rapat`,
    isi: teks
  });
  inputChat.value = '';
};

let permintaanTersimpan = {};

function perbaruiPermintaan(data) {
  const keys = Object.keys(data || {});
  jmlPermintaan.textContent = keys.length;
  permintaanBox.style.display = keys.length ? 'block' : 'none';
  permList.innerHTML = '';

  keys.forEach(k => {
    const orang = data[k];

    if (!permintaanTersimpan[k]) {
      db.ref(`rapat/${rapatId}/chat/${Date.now()}`).set({
        nama: '',
        isi: `${orang.nama} meminta izin untuk berbicara.`
      });
    }

    permintaanTersimpan[k] = orang;

    const row = document.createElement('div');
    row.innerHTML = `
      <span>${orang.nama}</span>
      <span>
        <button onclick="izinkan('${k}', '${orang.nama}')">Izinkan</button>
        <button onclick="tolak('${k}', '${orang.nama}')">Tolak</button>
      </span>
    `;
    permList.appendChild(row);
  });

  Object.keys(permintaanTersimpan).forEach(k => {
    if (!data || !data[k]) delete permintaanTersimpan[k];
  });
}

db.ref(`rapat/${rapatId}/permintaan`).on('value', snap => {
  perbaruiPermintaan(snap.val());
});

permintaanBox.onclick = () => {
  permList.style.display = permList.style.display === 'none' ? 'block' : 'none';
};

window.izinkan = (k, nama) => {
  db.ref(`rapat/${rapatId}/respon/${k}`).set('izinkan');
  db.ref(`rapat/${rapatId}/permintaan/${k}`).remove();
  db.ref(`rapat/${rapatId}/chat/${Date.now()}`).set({
    nama: '‚úÖPemimpin Rapat',
    isi: `Mengizinkan ${nama} untuk bicara`
  });
};

window.tolak = (k, nama) => {
  db.ref(`rapat/${rapatId}/respon/${k}`).set('tolak');
  db.ref(`rapat/${rapatId}/permintaan/${k}`).remove();
  db.ref(`rapat/${rapatId}/chat/${Date.now()}`).set({
    nama: '‚ùåPemimpin Rapat',
    isi: `Menolak permintaan bicara dari ${nama}`
  });
};

bukaVotingBtn.onclick = () => votingForm.style.display = 'block';

kirimVoting.onclick = () => {
  const judul = document.getElementById('judulVoting').value.trim();
  const opsi = document.getElementById('opsiVoting').value.trim().split('\n').filter(x => x);
  if (!judul || opsi.length < 2) return;
  const waktuMulai = Date.now();

  db.ref(`rapat/${rapatId}/voting`).set({ judul, opsi, waktuMulai });
  db.ref(`rapat/${rapatId}/chat/${Date.now()}`).set({
    nama: 'üó≥Ô∏è',
    isi: `Voting dimulai: "<b>${judul}</b>"`
  });

  votingForm.style.display = 'none';
  audio.play(); navigator.vibrate?.(300);

  votingCountdown.style.display = 'block';

  const interval = setInterval(() => {
    const sisa = 10 - Math.floor((Date.now() - waktuMulai) / 1000);
    votingCountdown.textContent = `‚è≥ Sisa waktu voting: ${sisa} detik`;
    if (sisa <= 0) {
      clearInterval(interval);
      votingCountdown.style.display = 'none';
    }
  }, 500);

  setTimeout(async () => {
    const snap = await db.ref(`rapat/${rapatId}/jawabanVoting`).get();
    const hasil = {};
    snap.forEach(s => {
      const val = s.val();
      hasil[val] = (hasil[val] || 0) + 1;
    });

    let teks = '<b>Hasil Voting</b><br><br>';
    opsi.forEach(o => {
      const jumlah = hasil[o] || 0;
      teks += `${o} ${jumlah} suara<br>`;
    });

    db.ref(`rapat/${rapatId}/chat/${Date.now()}`).set({
      nama: 'üìä',
      isi: teks.trim()
    });

    db.ref(`rapat/${rapatId}/voting`).remove();
    db.ref(`rapat/${rapatId}/jawabanVoting`).remove();
  }, 10000);
};
</script>

</body>
</html>