<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat Pribadi</title>
  <style>
    * {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background: #121212;
  color: white;
  display: flex;
}

header {
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  height: 64px;
  background: #1e1e1e;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  border-bottom: 1px solid #333;
  z-index: 1001;
}

header img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
}

header h1 {
  font-size: 18px;
  margin: 0;
}

header small {
  font-size: 12px;
  color: #ccc;
}

#kontakBtn {
  font-size: 22px;
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  display: inline-block;
}

@media (min-width: 768px) {
  #kontakBtn { display: none; }
}

aside#sidebar {
 position: fixed;
      top: 64px;
      left: 0;
      width: 240px;
      height: calc(100vh - 64px);
      background: #1f1f1f;
      padding: 24px 16px;
      overflow-y: auto;
      z-index: 1002;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }

aside#sidebar.show {
  transform: translateX(0);
}
@media (min-width: 768px) {
  aside#sidebar { transform: none !important; }
}
aside#sidebar h2 {
  font-size: 18px;
  margin-top: 0;
  margin-bottom: 24px;
}
aside#sidebar a {
       display: block;
  color: #ccc;
  text-decoration: none;
  padding: 12px;
  border-radius: 6px;
  font-size: 14px;
  margin-bottom: 8px;
  background: #2a2a2a;
  transition: background 0.2s;
}

aside#sidebar a:hover {
  background: #333;
  color: #fff;
}

aside#kontakSidebar {
  position: fixed;
  top: 64px;
  right: 0;
  width: 100%;
  max-width: 240px;
  height: calc(100vh - 64px);
  background: #1f1f1f;
  padding: 16px;
  overflow-y: auto;
  z-index: 1002;
  transform: translateX(100%);
  transition: transform 0.3s ease;
  box-shadow: -2px 0 10px rgba(0, 0, 0, 0.5);
}
aside#kontakSidebar.show {
  transform: translateX(0);
}
@media (min-width: 768px) {
  aside#kontakSidebar {
    transform: none !important;
    border-left: 1px solid #333;
  }
}
aside#kontakSidebar h2 {
  font-size: 16px;
  margin: 0 0 16px;
}

main {
  flex: 1;
  padding: 88px 16px 80px;
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}
@media (min-width: 768px) {
  main {
    margin-left: 240px;
    margin-right: 240px;
  }
}

#chatArea {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.bubble {
  background: #1e1e1e;
  border: 1px solid #333;
  padding: 10px 14px;
  border-radius: 10px;
  max-width: 90%;
  word-wrap: break-word;
  align-self: flex-start;
}
.bubble.mine {
  align-self: flex-end;
  background: #2a2a2a;
}
.bubble .meta {
  font-size: 12px;
  color: #aaa;
  margin-bottom: 4px;
}

form {
  display: flex;
  position: fixed;
  bottom: env(keyboard-inset-height, 0);
  left: 0;
  right: 0;
  background: #1a1a1a;
  padding: 12px 16px;
  gap: 8px;
  z-index: 1001;
  border-top: 1px solid #333;
}
@media (min-width: 768px) {
  form { left: 240px; right: 240px; }
}
form input {
  flex: 1;
  padding: 10px;
  font-size: 16px;
  border: 1px solid #444;
  border-radius: 20px;
  background: #2a2a2a;
  color: white;
}
form button {
  width: 40px;
  height: 40px;
  font-size: 20px;
  border: none;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
  color: white;
  cursor: pointer;
}

.kontak-item {
  position: relative;
  padding: 8px 12px;
  margin-bottom: 10px;
  background: #2a2a2a;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  overflow: hidden;
}
.kontak-item:hover {
  background: #333;
}
.kontak-item b {
  display: block;
  font-size: 14px;
  color: white;
  margin-bottom: 2px;
}
.kontak-item small {
  display: block;
  color: #aaa;
  font-size: 11px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: calc(100% - 30px);
}
.badge {
  position: absolute;
  top: 10px;
  right: 12px;
  background: red;
  color: white;
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 50px;
}

#overlay, #overlayKontak {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
}
#overlay.show, #overlayKontak.show {
  display: block;
}
@media (min-width: 768px) {
  #overlay, #overlayKontak {
    display: none !important;
  }
}

  </style>
</head>
<body>
  <audio id="notif1" src="sound/notif1.mp3" preload="auto"></audio>
  <audio id="notif2" src="sound/notif2.mp3" preload="auto"></audio>

  <div id="overlay" onclick="tutupSidebar()"></div>
  <div id="overlayKontak" onclick="tutupKontak()"></div>

  <header>
    <img src="1.png" alt="Foto" onclick="toggleSidebar()" />
    <div style="flex-grow: 1;">
      <h1 id="fnamaHeader">Chat Pribadi</h1>
      <small id="fjabatanHeader"></small>
    </div>
    <button id="kontakBtn" onclick="toggleKontak()">üìá</button>
  </header>

   <aside id="sidebar">
    <h2>üìö Menu</h2>
    <a href="profil.html?id=" id="linkProfil">üë§ Profil</a>
    <a href="beranda.html?id=" id="linkBeranda">üè† Beranda</a>
    <a href="penugasan.html?id=" id="linkPenugasan">üìÑ Penugasan</a>
    <a href="catatan.html?id=" id="linkCatatan">üìî Catatan</a>
    <a href="chat.html?id=" id="linkChat">üí¨ Chat</a>
    <a href="chat-umum.html?id=" id="linkChatUmum">üí¨ Chat Umum</a>
    <a href="rapat.html?id=" id="linkRapat">üìÖ Rapat</a>
    <a href="daftarpustakawan.html?id=" id="linkDaftarPustakawan">üë§ Daftar Pustakawan</a>
  </aside>

  <aside id="kontakSidebar">
    <h2>üìá Daftar Pustakawan</h2>
    <div id="daftarKontak">Memuat...</div>
  </aside>

  <main>
    <div id="chatArea"></div>
  </main>

  <form id="formKirim">
    <input id="pesanInput" placeholder="Tulis pesan..." autocomplete="off" />
    <button type="submit">‚û§</button>
  </form>
<script type="module">
import {
  initializeApp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

import {
  getDatabase,
  ref,
  push,
  set,
  onChildAdded,
  get,
  query,
  limitToLast,
  remove,
  onValue
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDguC7UH1JUzBQu1JZX8qPJGVeb6Pc7t98",
  authDomain: "pustakawan-26664.firebaseapp.com",
  projectId: "pustakawan-26664",
  storageBucket: "pustakawan-26664.appspot.com",
  messagingSenderId: "284579513964",
  appId: "1:284579513964:web:b45f73ac287e1f49eeba49",
  databaseURL: "https://pustakawan-26664-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const urlParams = new URLSearchParams(location.search);
const id = urlParams.get("id");
const tujuan = urlParams.get("tujuan");

const linkIDs = [
  "linkProfil",
  "linkBeranda",
  "linkPenugasan",
  "linkCatatan",
  "linkChat",
  "linkChatUmum",
  "linkRapat",
  "linkDaftarPustakawan"
];

linkIDs.forEach(linkId => {
  const el = document.getElementById(linkId);
  if (el && id) {
    const url = new URL(el.getAttribute("href"), location.href);
    url.searchParams.set("id", id);
    el.setAttribute("href", url.toString());
  }
});

const pasangan = [id, tujuan].sort().join("_");
const chatRef = ref(db, `chatpribadi/${pasangan}`);
const pesanQuery = query(chatRef, limitToLast(45));

const chatArea = document.getElementById("chatArea");
const pesanInput = document.getElementById("pesanInput");
const notifSaya = document.getElementById("notif1");
const notifOrang = document.getElementById("notif2");
const daftarKontak = document.getElementById("daftarKontak");
let nama = "Anonim";
let lastPesanId = "";

async function init() {
  if (id) {
    const snap = await get(ref(db, `pustakawan/${id}`));
    if (snap.exists()) {
      const data = snap.val();
      nama = data.nama || "Pustakawan";
      document.getElementById("fnamaHeader").textContent = nama;
      document.getElementById("fjabatanHeader").textContent = data.jabatan || "";
    }
  }

  tampilkanKontak();

  onChildAdded(pesanQuery, async snap => {
    const data = snap.val();
    if (snap.key !== lastPesanId) {
      tampilkanPesan(data);
      lastPesanId = snap.key;
      if (data.dari === id) {
        notifSaya.play();
      } else {
        notifOrang.play();
      }
      // tandai pesan dari orang lain sebagai dibaca
      if (data.dari === tujuan && data.ke === id && !data.dibaca) {
        await set(ref(db, `chatpribadi/${pasangan}/${snap.key}`), {
          ...data,
          dibaca: true
        });
      }
    }
  });

  const semuaPesan = await get(chatRef);
  if (semuaPesan.exists()) {
    const semua = Object.entries(semuaPesan.val());
    if (semua.length > 45) {
      const berapaHapus = semua.length - 45;
      const yangDihapus = semua.slice(0, berapaHapus);
      for (const [keyLama] of yangDihapus) {
        await remove(ref(db, `chatpribadi/${pasangan}/${keyLama}`));
      }
    }
  }

  document.getElementById("formKirim").addEventListener("submit", kirimPesan);
}

function tampilkanPesan(data) {
  const div = document.createElement("div");
  div.className = "bubble";
  if (data.dari === id) div.classList.add("mine");

  const meta = document.createElement("div");
  meta.className = "meta";
  const waktu = new Date(data.waktu).toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });
  meta.textContent = `${data.nama} ‚Ä¢ ${waktu}`;

  const isi = document.createElement("div");
  isi.textContent = data.teks;

  div.appendChild(meta);
  div.appendChild(isi);
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
}

async function tampilkanKontak() {
  const userList = await get(ref(db, "pustakawan"));
  if (userList.exists()) {
    daftarKontak.innerHTML = "";
    const data = userList.val();

    Object.entries(data).forEach(([uid, val]) => {
      if (uid === id) return;

      const pasangan = [id, uid].sort().join("_");
      const kontakRef = ref(db, `chatpribadi/${pasangan}`);

      const div = document.createElement("div");
      div.className = "kontak-item";
      div.innerHTML = `<b>${val.nama || uid}</b><small id="cuplikan-${uid}">Memuat...</small><span class="badge" id="badge-${uid}" style="display:none">0</span>`;
      div.onclick = () => location.href = `chat.html?id=${id}&tujuan=${uid}`;

      daftarKontak.appendChild(div);

      let pesanBaru = 0;

      onValue(kontakRef, snap => {
        let lastMsg = "";
        pesanBaru = 0;
        snap.forEach(child => {
          const data = child.val();
          if (data) {
            lastMsg = data.teks;
            if (data.dari === uid && data.ke === id && !data.dibaca) {
              pesanBaru++;
            }
          }
        });

        document.getElementById(`cuplikan-${uid}`).textContent =
          lastMsg.length > 25 ? lastMsg.substring(0, 22) + "..." : lastMsg;

        const badge = document.getElementById(`badge-${uid}`);
        if (pesanBaru > 0 && (!tujuan || uid !== tujuan)) {
  badge.style.display = "inline-block";
  badge.textContent = pesanBaru;
} else {
  badge.style.display = "none";
}

      });
    });
  }
}

async function kirimPesan(e) {
  e.preventDefault();
  const teks = pesanInput.value.trim();
  if (!teks) return;

  await set(push(chatRef), {
    dari: id,
    ke: tujuan,
    nama: nama,
    teks: teks,
    waktu: Date.now(),
    dibaca: false
  });

  pesanInput.value = "";
}

init();

  window.toggleSidebar = () => {
  document.getElementById("sidebar").classList.toggle("show");
  document.getElementById("overlay").classList.toggle("show");
};

window.tutupSidebar = () => {
  document.getElementById("sidebar").classList.remove("show");
  document.getElementById("overlay").classList.remove("show");
};

window.toggleKontak = () => {
  document.getElementById("kontakSidebar").classList.toggle("show");
  document.getElementById("overlayKontak").classList.toggle("show");
};

window.tutupKontak = () => {
  document.getElementById("kontakSidebar").classList.remove("show");
  document.getElementById("overlayKontak").classList.remove("show");
};

  setTimeout(() => {
  chatArea.scrollTop = chatArea.scrollHeight;
}, 300);

</script>

</body>
</html>
